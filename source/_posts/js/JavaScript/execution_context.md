---
layout: post
title: js执行环境及作用域
date: 2014-12-12
category: js
tags: [js]
toc: true
---
## 执行环境及作用域
执行环境(execution context)定义了变量的或函数有权访问的其他数据，决定了它们各自的行为。每个执行环境都有一个与之关联的**变量对象**`variable object`，环境中定义的所有变量和函数都保存在这个对象中。<!--more-->虽然我们编写代码时无法访问这个对象，但解析器解析在处理数据时会在后台使用它。

全局执行环境是最外围的一个执行环境。根据ECMAScript实现所在的宿主环境不同，表示执行环境的对象也不一样。在Web浏览器中，全局执行环境被认为是`window`对象，因此所有全局变量和函数都是作为`window`对象的属性和方法创建的。某个执行环境中的所有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁(全局执行环境直到应用程序退出——例如关闭网页或浏览器——时才会被销毁)。

每个函数都有自己的执行环境，当执行流进入一个函数时，函数的环境就会被推入一个环境栈中。而在函数执行之后，栈将其环境弹出，把控制权返回给之前的执行环境。ECMAScript程序中的流正是由这个方便的机制控制着。

当代码在一个环境中执行时，会创建变量对象的一个**作用域链**`scope chain`。作用域链的用途，是保证对执行环境有权限访问的所有变量和函数的有序访问。作用域链的前端，始终都是当前执行的代码所在的环境变量对象。如果这个环境是函数，则将其**活动对象**`activation object`作为变量对象。活动对象在最开始时只包含(外部)环境，而再下一个环境变量对象则来自下一个包含环境。这样，一直延续到全局执行环境;全局执行环境的变量对象始终都是作用域链中的最后一个对象。

标识符解析是沿着作用域链一级一级地搜索标识符过程。搜索过程始终从作用域链的前端开始，然后逐级地向后回溯，直至找到标识符为止(如果找不到标识符，通常会导致错误发生)
请看下面的示例代码:
```
var color = “blue”;
function changeColor()
{
    if (color == “blue”)
    {
        color = “red”;
    }
    else
    {
        color = “blue”;
    }
}
changeColor();
alert(“Color is now ” + color);
```
在这个简单的例子中，函数`changeColor()`的作用域链包含两个对象：它自己的变量对象(其中定义着`arguments`对象)和全局环境变量对象。可以在函数内部访问变量`color`,就是因为可以在这个作用域链中找到它。
此外，在局部作用域中定义的变量可以在局部环境中与全局变量互换使用，如下图这个例子所示：
```
var color = “blue”;
function changeColor()
{
    var anotherColor = “red”;

    function swapColors()
    {
        var temColor = anotherColor;
        anotherColor = color;
        color = temColor;
    }
    swapColors();
}

changeColor();
```
以上代码共涉及3个执行环境:全局环境、`changeColor()`的局部环境和`swapColor()`的局部环境。

## 延长作用域链
虽然执行环境的类型总共只有两种——全局和局部(函数)，但还有其他办法来延长作用域链。因为有些语句可以在作用域链的前端临时增加一个变量对象，该变量对象会在代码执行后被移除。在这两种情况下会发生这种现象。
  * `try-catch`语句的`catch`块;
  * `with`语句
这两个语句都会在作用域链的前端添加一个变量对象。对`with`语句来说，会将指定的对象添加到作用域链中。对`catch`语句来说，会创建一个新的变量对象，其中包含的是被抛出的错误对象的声明。
```
function buildUrl()
{
    var qs=”?debug=true”;
    with(location)
    {
        var url = href+qs;
    }
    return url;
}
```

## 没有块级作用域
JavaScript没有块级作用域经常会导致理解上的困难。下面代码并不会得到想象中的结果:
```
if(true)
{
    var color=”blue”;
}
alert(color);   //”blue”
```
在使用`for`循环时要牢记这一差异，
```
for(var i=0; i<10; i++)
{
    doSomething(i);
}
alert(i);   //10
```

**声明变量**
使用`var`声明变量会自动被添加到最接近的环境中。不声明变量而直接初始化变量可能导致意外。

**查询标识符**
当在某个环境中为了读取或写入而引入一个标识符时，会通过搜索来确定该标识符实际代表什么。搜索过程从作用域前端开始，向上逐级查询与给定名字匹配的标识符。
